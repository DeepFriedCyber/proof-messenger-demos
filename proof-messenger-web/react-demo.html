<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>React Integration Demo - Proof Messenger</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            margin: 0 auto;
            max-width: 800px;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 30px;
        }
        
        .section {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .button {
            background: #4f46e5;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 12px 24px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .button:hover:not(:disabled) {
            background: #4338ca;
        }
        
        .button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .input {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 15px;
            box-sizing: border-box;
        }
        
        .code-block {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            word-break: break-all;
            margin: 10px 0;
        }
        
        .error {
            background: #fee2e2;
            color: #dc2626;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
        
        .success {
            background: #d1fae5;
            color: #065f46;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Mock Zustand store for E2E testing
        const useKeyStore = () => {
            const [state, setState] = useState({
                status: 'uninitialized',
                hasKeyPair: false,
                publicKey: null,
                error: null
            });

            const generateAndStoreKeyPair = async () => {
                setState(prev => ({ ...prev, status: 'generating' }));
                
                try {
                    // Simulate WASM key generation
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // Mock public key (in real app, this comes from WASM)
                    const mockPublicKey = 'a1b2c3d4e5f6789012345678901234567890abcdef1234567890abcdef123456';
                    
                    setState({
                        status: 'ready',
                        hasKeyPair: true,
                        publicKey: mockPublicKey,
                        error: null
                    });
                } catch (error) {
                    setState(prev => ({ 
                        ...prev, 
                        status: 'error', 
                        error: error.message 
                    }));
                }
            };

            const sign = (messageBytes) => {
                if (!state.hasKeyPair) {
                    throw new Error('No keypair available. Please generate a keypair first.');
                }
                
                // Mock signature generation (in real app, this happens in WASM)
                const mockSignature = new Uint8Array(64);
                for (let i = 0; i < 64; i++) {
                    mockSignature[i] = Math.floor(Math.random() * 256);
                }
                return mockSignature;
            };

            const reset = () => {
                setState({
                    status: 'uninitialized',
                    hasKeyPair: false,
                    publicKey: null,
                    error: null
                });
            };

            return {
                ...state,
                generateAndStoreKeyPair,
                sign,
                reset,
                isReady: state.status === 'ready'
            };
        };

        function ReactDemo() {
            const [message, setMessage] = useState('Hello from React E2E test!');
            const [signature, setSignature] = useState(null);
            const [error, setError] = useState(null);
            
            const keyStore = useKeyStore();

            const handleGenerateKey = async () => {
                setError(null);
                try {
                    await keyStore.generateAndStoreKeyPair();
                } catch (err) {
                    setError(err.message);
                }
            };

            const handleSignMessage = () => {
                setError(null);
                try {
                    const messageBytes = new TextEncoder().encode(message);
                    const signatureBytes = keyStore.sign(messageBytes);
                    
                    // Convert to hex for display
                    const signatureHex = Array.from(signatureBytes)
                        .map(b => b.toString(16).padStart(2, '0'))
                        .join('');
                    
                    setSignature(signatureHex);
                } catch (err) {
                    setError(err.message);
                }
            };

            const handleReset = () => {
                keyStore.reset();
                setSignature(null);
                setError(null);
            };

            return (
                <div className="container" data-testid="react-app">
                    <h1>‚öõÔ∏è React Integration Demo</h1>
                    <p>Testing React component integration with secure key management</p>

                    {/* Status Section */}
                    <div className="section">
                        <h2>üîç Key Store Status</h2>
                        <div>
                            Status: <span data-testid="key-status">{keyStore.status}</span>
                        </div>
                        <div>
                            Has Keypair: <span data-testid="has-keypair">{keyStore.hasKeyPair.toString()}</span>
                        </div>
                        <div>
                            Ready: <span data-testid="is-ready">{keyStore.isReady.toString()}</span>
                        </div>
                    </div>

                    {/* Key Generation Section */}
                    <div className="section">
                        <h2>üîë Key Generation</h2>
                        <button 
                            className="button"
                            data-testid="generate-key-btn"
                            onClick={handleGenerateKey}
                            disabled={keyStore.status === 'generating'}
                        >
                            {keyStore.status === 'generating' ? '‚è≥ Generating...' : 'üîë Generate Keypair'}
                        </button>
                        
                        <button 
                            className="button"
                            data-testid="reset-btn"
                            onClick={handleReset}
                        >
                            üîÑ Reset
                        </button>

                        {keyStore.publicKey && (
                            <div>
                                <h3>üìã Public Key</h3>
                                <div className="code-block" data-testid="public-key">
                                    {keyStore.publicKey}
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Message Signing Section */}
                    <div className="section">
                        <h2>‚úçÔ∏è Message Signing</h2>
                        <input
                            className="input"
                            data-testid="message-input"
                            type="text"
                            value={message}
                            onChange={(e) => setMessage(e.target.value)}
                            placeholder="Enter message to sign..."
                        />
                        
                        <button 
                            className="button"
                            data-testid="sign-btn"
                            onClick={handleSignMessage}
                            disabled={!keyStore.isReady || !message.trim()}
                        >
                            ‚úçÔ∏è Sign Message
                        </button>

                        {signature && (
                            <div>
                                <h3>üîè Signature</h3>
                                <div className="code-block" data-testid="signature">
                                    {signature}
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Error Display */}
                    {error && (
                        <div className="error" data-testid="error-message">
                            ‚ùå Error: {error}
                        </div>
                    )}

                    {/* Success Indicator */}
                    {keyStore.status === 'ready' && (
                        <div className="success" data-testid="success-message">
                            ‚úÖ Keypair generated successfully!
                        </div>
                    )}
                </div>
            );
        }

        // Render the React app
        ReactDOM.render(<ReactDemo />, document.getElementById('root'));
    </script>
</body>
</html>